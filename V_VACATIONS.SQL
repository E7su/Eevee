CREATE OR REPLACE FORCE VIEW JIRA_READER.V_VACATIONS AS
  SELECT
    COALESCE(u1.DISPLAY_NAME, u2.DISPLAY_NAME, j.REPORTER) AS fio,
    TRUNC(c1.DATEVALUE) AS DATE_START,
    TRUNC(c2.DATEVALUE) AS DATE_END,
    c3.STRINGVALUE AS TIME_START,
    c4.STRINGVALUE AS TIME_END,
    c5.STRINGVALUE AS REASON_ID,
    j.REPORTER AS REPORTER,
    j.ISSUENUM AS ISSUENUM
  FROM jira.jiraISSUE j
    INNER JOIN jira.PROJECT p ON (j.PROJECT = p.ID AND p.PKEY = 'VAC')
    LEFT JOIN jira.CUSTOMFIELDVALUE c1 ON (c1.ISSUE = j.ID AND c1.CUSTOMFIELD = 12672) -- Vacation Start Date
    LEFT JOIN jira.CUSTOMFIELDVALUE c2 ON (c2.ISSUE = j.ID AND c2.CUSTOMFIELD = 12673) -- Vacation End Date
    LEFT JOIN jira.CUSTOMFIELDVALUE c3 ON (c3.ISSUE = j.ID AND c3.CUSTOMFIELD = 12670) -- Vacation Start Time
    LEFT JOIN jira.CUSTOMFIELDVALUE c4 ON (c4.ISSUE = j.ID AND c4.CUSTOMFIELD = 12671) -- Vacation End Time
    LEFT JOIN jira.CUSTOMFIELDVALUE c5 ON (c5.ISSUE = j.ID AND c5.CUSTOMFIELD = 12871) -- Vacation Reason
    LEFT JOIN jira.CUSTOMFIELDOPTION o5 ON (c5.STRINGVALUE = TO_CHAR(o5.ID))
    LEFT JOIN jira.CWD_USER u1 ON (lower(j.REPORTER) = u1.LOWER_USER_NAME)
    LEFT JOIN jira.CWD_USER u2 ON (u2.LOWER_EMAIL_ADDRESS LIKE lower(j.REPORTER || '@%')) --не все пользователи ищутся по LOWER_USER_NAME, пробуем найти по email
  WHERE
    j.issuestatus IN (10015, 11507, 11705); -- Done, Confirmation, Planning


COMMENT ON COLUMN V_VACATIONS.FIO IS 'ФИО';
COMMENT ON COLUMN V_VACATIONS.DATE_START IS 'Дата начала';
COMMENT ON COLUMN V_VACATIONS.DATE_END IS 'Дата завершения';
COMMENT ON COLUMN V_VACATIONS.TIME_START IS 'Время начала';
COMMENT ON COLUMN V_VACATIONS.TIME_END IS 'Время завершения';
COMMENT ON COLUMN V_VACATIONS.REASON_ID IS 'Причина';
COMMENT ON COLUMN V_VACATIONS.REPORTER IS 'Автор';
COMMENT ON COLUMN V_VACATIONS.ISSUENUM IS 'Номер задачи';
